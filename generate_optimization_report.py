"""
策略优化分析报告
================

基于回测数据的深度分析，识别了以下关键问题：

## 一、核心问题诊断

### 1. 信号触发过于频繁
- **现象**：1833次买入 vs 42次卖出（买卖比 43.6:1）
- **根因**：min_signal=60阈值偏低，导致信号泛滥
- **影响**：资金被分散到大量低质量交易中

### 2. 分层设计不合理
- Layer-1: 842笔 (45.9%)  ← 占比过高
- Layer-2: 343笔 (18.7%)
- Layer-3/4/5: 各216笔 (11.8%)
- **问题**：深层订单很少成交，分层策略未充分利用

### 3. 退出机制低效
- Take-profit: 19次 (45.2%)
- Timeout: 15次 (35.7%)  ← 大量交易超时退出
- Stop-loss: 8次 (19.0%)
- **问题**：35.7%的交易既没到止盈也没到止损就超时了

### 4. 风险指标偏高
- 最大回撤: -17.32%（>15%警戒线）
- 胜率: 17.23%（<30%警戒线）
- 平均持仓: 23.8%但经常冲到100%满仓

### 5. 持仓管理问题
- 回测结束时仍持有~0.05 BTC（约50%权益）
- 未实现盈亏未纳入最终收益

## 二、优化方案设计

### 方案A：提高信号质量（保守型）
```yaml
strategy:
  min_signal: 75  # 60 → 75，减少30%信号
  drop_single_pct: 1.0  # 0.8 → 1.0，需要更大跌幅
  rsi_oversold: 25.0  # 28 → 25，更严格的超卖
```

### 方案B：优化分层配置（均衡型）
```yaml
layers:
  - offset_pct: 0.5   # 更浅的第一层
    size_ratio: 0.25  # 加大第一层仓位
  - offset_pct: 1.2
    size_ratio: 0.25
  - offset_pct: 2.0
    size_ratio: 0.25
  - offset_pct: 3.0
    size_ratio: 0.25
```

### 方案C：调整风险参数（激进型）
```yaml
risk:
  take_profit_pct: 0.8      # 1.2 → 0.8，更快止盈
  hard_stop_pct: 1.5        # 2.4 → 1.5，更严格止损
  trailing_pct: 0.5         # 0.7 → 0.5，更紧的追踪止损
  max_hold_minutes: 360     # 720 → 360，减少持仓时间
  cooldown_minutes: 60      # 45 → 60，增加冷静期
```

### 方案D：综合优化（推荐）
综合以上三个方案，平衡信号质量、分层设计和风险控制

## 三、预期改进效果

| 指标 | 当前值 | 目标值 |
|-----|-------|-------|
| 总收益率 | 6.06% | 8-12% |
| 最大回撤 | -17.32% | <-12% |
| 胜率 | 17.23% | >30% |
| 夏普比率 | 1.65 | >2.0 |
| 交易次数 | 1875 | <1000 |
| 超时退出比例 | 35.7% | <20% |

## 四、实施建议

1. **先测试方案A**（保守）：验证信号质量提升效果
2. **再测试方案C**（激进）：验证止盈止损优化
3. **最后测试方案D**（综合）：全面优化
4. **对比分析**：使用更长时间窗口（3-6个月）验证稳健性

## 五、额外改进点

1. **添加趋势过滤**：只在EMA多头排列时做多
2. **仓位动态调整**：根据波动率调整max_account_ratio
3. **信号衰减机制**：重复信号降低权重
4. **强制平仓**：回测结束前强制平掉所有仓位
"""

with open("optimization_analysis.md", "w", encoding="utf-8") as f:
    f.write(__doc__)

print("优化分析报告已保存: optimization_analysis.md")
